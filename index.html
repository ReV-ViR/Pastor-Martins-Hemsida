<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <title>Pastor Martins Hemsida</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
    }

    header {
      background-color: #005b96;
      color: white;
      text-align: center;
      padding: 20px;
    }

    header h1 {
      margin: 0;
      font-size: 2.5rem;
    }

    header p {
      margin: 5px 0 0;
      font-size: 1.2rem;
    }

    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* --- Intro / teologisk ram --- */
    .intro-box {
      background: #eef5ff;
      border-left: 4px solid #005b96;
      padding: 12px 16px;
      margin-bottom: 18px;
      border-radius: 6px;
      font-style: italic;
    }
    .intro-box p { margin: 0; }

    .tab-container {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      background: #ddd;
      border-radius: 8px;
      flex-wrap: wrap;
      overflow: hidden;
    }

    .tab {
      padding: 12px 14px;
      cursor: pointer;
      text-align: center;
      flex: 1;
      min-width: 160px;
      font-weight: bold;
      background: #ddd;
      border-right: 1px solid #bbb;
      transition: background 0.2s;
      user-select: none;
    }

    .tab:last-child {
      border-right: none;
    }

    .tab:hover {
      background: #cce0ff;
    }

    .tab.active {
      background: #005b96;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      background: #f4f4f4;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
    }

    h2 {
      margin-top: 0;
    }

    h3 {
      margin: 0 0 10px;
      line-height: 1.25;
    }

    audio {
      width: 100%;
    }

    footer {
      margin-top: 20px;
      text-align: center;
      background: #005b96;
      color: white;
      padding: 10px;
    }

    footer a {
      color: #ffd700;
      text-decoration: none;
    }

    /* --- Player UI enhancements --- */
    li.playing {
      border-left: 6px solid #005b96;
      background: #eef5ff;
    }

    .now-playing {
      display: inline-block;
      font-size: 0.85rem;
      font-weight: 700;
      margin-left: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #005b96;
      color: #fff;
      vertical-align: middle;
      white-space: nowrap;
    }

    .time-badge {
      display: inline-block;
      font-size: 0.85rem;
      margin-left: 8px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e9e9e9;
      color: #333;
      vertical-align: middle;
      white-space: nowrap;
    }

    /* --- Tydligare hierarki i långa listor --- */
    .section-label {
      margin: 18px 0 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f0f0f0;
      font-weight: 700;
    }

    /* --- Mini-player (nere på skärmen) --- */
    .mini-player {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.98);
      border-top: 1px solid #ddd;
      box-shadow: 0 -6px 18px rgba(0,0,0,0.08);
      padding: 10px 12px;
      display: none;
      z-index: 9999;
    }

    .mini-player.active {
      display: block;
    }

    .mini-row {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .mini-left {
      flex: 1;
      min-width: 0;
    }

    .mini-title {
      font-weight: 700;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mini-sub {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-top: 2px;
    }

    .mini-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 2;
      min-width: 0;
    }

    .mini-btn {
      background: #005b96;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .mini-btn.secondary {
      background: #e9e9e9;
      color: #333;
      font-weight: 700;
    }

    .mini-range {
      width: 100%;
    }

    .mini-time {
      font-size: 0.85rem;
      white-space: nowrap;
      opacity: 0.9;
    }

    /* Gör plats för mini-player så footer inte hamnar under den */
    body.has-mini-player {
      padding-bottom: 76px;
    }

    /* --- Mobil först (lite extra kärlek) --- */
    @media (max-width: 600px) {
      header h1 { font-size: 2rem; }
      header p { font-size: 1rem; }

      main {
        margin: 12px;
        padding: 14px;
      }

      .tab {
        min-width: 48%;
        padding: 14px 10px;
        border-right: none;
        border-bottom: 1px solid #bbb;
      }

      .tab-container {
        border-radius: 10px;
      }

      li {
        padding: 14px;
      }

      h3 {
        font-size: 1.05rem;
      }

      .now-playing, .time-badge {
        margin-top: 6px;
        margin-left: 0;
      }

      .badges {
        display: block;
        margin-top: 6px;
      }

      .mini-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .mini-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .mini-btn {
        width: 100%;
        text-align: center;
      }

      .mini-time {
        text-align: right;
      }

      body.has-mini-player {
        padding-bottom: 140px;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Pastor Martins Hemsida</h1>
    <p>En plats för undervisning och inspiration.</p>
  </header>

  <main>
    <div class="intro-box">
      <p>Lyssna gärna i ordning. Pröva allt mot Skriften och behåll det goda.</p>
    </div>

    <div class="tab-container">
      <div class="tab active" data-tab="tab1">Blodsförbundet</div>
      <div class="tab" data-tab="tab2">Bön</div>
      <div class="tab" data-tab="tab3">Den Helige Ande</div>
      <div class="tab" data-tab="tab4">Försoningslära</div>
      <div class="tab" data-tab="tab5">Kyrkohistoria</div>
      <div class="tab" data-tab="tab6">Sex och relationer</div>
      <div class="tab" data-tab="tab7">Änglar och demoner</div>
    </div>

    <div class="tab-content active" id="tab1">
      <h2>Blodsförbundet</h2>
      <p><strong>Tack Ola Gustavsson för inspirationen – mycket av materialet är hämtat från dina undervisningar.</strong></p>
      <ul>
        <li><h3>Blodsförbundet Del 1</h3><audio controls><source src="Blodsfoerbundet Del 1.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 2</h3><audio controls><source src="Blodsfoerbundet Del 2.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 3</h3><audio controls><source src="Blodsfoerbundet Del 3.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 4</h3><audio controls><source src="Blodsfoerbundet Del 4.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 5</h3><audio controls><source src="Blodsfoerbundet Del 5.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 6</h3><audio controls><source src="Blodsfoerbundet Del 6.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 7</h3><audio controls><source src="Blodsfoerbundet Del 7.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 8</h3><audio controls><source src="Blodsfoerbundet Del 8.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 9</h3><audio controls><source src="Blodsfoerbundet Del 9.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 10</h3><audio controls><source src="Blodsfoerbundet Del 10.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 11</h3><audio controls><source src="Blodsfoerbundet Del 11.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 12</h3><audio controls><source src="Blodsfoerbundet Del 12.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 13</h3><audio controls><source src="Blodsfoerbundet Del 13.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 14</h3><audio controls><source src="Blodsfoerbundet Del 14.m4a" type="audio/mp4"></audio></li>
        <li><h3>Blodsförbundet Del 15</h3><audio controls><source src="Blodsfoerbundet Del 15.m4a" type="audio/mp4"></audio></li>
      </ul>
    </div>

    <div class="tab-content" id="tab2">
      <h2>Bön</h2>
      <ul>
        <li><h3>Bön Del 1</h3><audio controls><source src="Boen Del 1.m4a" type="audio/mp4"></audio></li>
        <li><h3>Bön Del 2</h3><audio controls><source src="Boen Del 2.m4a" type="audio/mp4"></audio></li>
        <li><h3>Bön Del 3</h3><audio controls><source src="Boen Del 3.m4a" type="audio/mp4"></audio></li>
      </ul>
    </div>

    <div class="tab-content" id="tab3">
      <h2>Den Helige Ande</h2>
      <ul>
        <li><h3>Den Helige Ande – Del 1</h3><audio controls><source src="Den Helige Ande Del 1.m4a" type="audio/mp4"></audio></li>
        <li><h3>Den Helige Ande – Del 2</h3><audio controls><source src="Den Helige Ande Del 2.m4a" type="audio/mp4"></audio></li>
      </ul>
    </div>

    <div class="tab-content" id="tab4">
      <h2>Försoningslära</h2>
      <ul>
        <li><h3>Försoningslära – Del 1</h3><audio controls><source src="Försoningslära Del 1.m4a" type="audio/mp4"></audio></li>
        <li><h3>Försoningslära – Del 2</h3><audio controls><source src="Försoningslära Del 2.m4a" type="audio/mp4"></audio></li>
        <li><h3>Försoningslära – Del 3</h3><audio controls><source src="Försoningslära Del 3.m4a" type="audio/mp4"></audio></li>
      </ul>
    </div>

    <div class="tab-content" id="tab5">
      <h2>Kyrkohistoria</h2>

      <div class="section-label">Kyrkohistoria</div>
      <ul>
        <li><h3>Kyrkohistoria Del 1</h3><audio controls><source src="Kyrkohistoria Del 1.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 2</h3><audio controls><source src="Kyrkohistoria Del 2.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 3</h3><audio controls><source src="Kyrkohistoria Del 3.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 4</h3><audio controls><source src="Kyrkohistoria Del 4.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 5</h3><audio controls><source src="Kyrkohistoria Del 5.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 6</h3><audio controls><source src="Kyrkohistoria Del 6.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 7</h3><audio controls><source src="Kyrkohistoria Del 7.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 8</h3><audio controls><source src="Kyrkohistoria Del 8.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 9</h3><audio controls><source src="Kyrkohistoria Del 9.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 10</h3><audio controls><source src="Kyrkohistoria Del 10.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 11</h3><audio controls><source src="Kyrkohistoria Del 11.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 12</h3><audio controls><source src="Kyrkohistoria Del 12.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 13</h3><audio controls><source src="Kyrkohistoria Del 13.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 14</h3><audio controls><source src="Kyrkohistoria Del 14.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 15</h3><audio controls><source src="Kyrkohistoria Del 15.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 16</h3><audio controls><source src="Kyrkohistoria Del 16.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 17</h3><audio controls><source src="Kyrkohistoria Del 17.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 18</h3><audio controls><source src="Kyrkohistoria Del 18.m4a" type="audio/mp4"></audio></li>
        <li><h3>Kyrkohistoria Del 19</h3><audio controls><source src="Kyrkohistoria Del 19.m4a" type="audio/mp4"></audio></li>
      </ul>

      <div class="section-label">Pingstväckelsens historia</div>
      <ul>
        <li><h3>Pingstväckelsens historia Del 1</h3><audio controls><source src="Pingstväckelsens historia Del 1.mp3" type="audio/mpeg"></audio></li>
        <li><h3>Pingstväckelsens historia Del 2</h3><audio controls><source src="Pingstväckelsens historia Del 2.mp3" type="audio/mpeg"></audio></li>
      </ul>
    </div>

    <div class="tab-content" id="tab6">
      <h2>Sex och relationer</h2>
      <ul>
        <li><h3>Sex och relationer Del 1</h3><audio controls><source src="Sex och relationer Del 1.m4a" type="audio/mp4"></audio></li>
        <li><h3>Sex och relationer Del 2</h3><audio controls><source src="Sex och relationer Del 2.m4a" type="audio/mp4"></audio></li>
      </ul>
    </div>

    <div class="tab-content" id="tab7">
      <h2>Änglar och demoner</h2>
      <ul>
        <li><h3>Änglar och demoner – Del 1</h3><audio controls><source src="Anglar och demoner Del 1.m4a" type="audio/mp4"></audio></li>
        <li><h3>Änglar och demoner – Del 2</h3><audio controls><source src="Anglar och demoner Del 2.m4a" type="audio/mp4"></audio></li>
        <li><h3>Änglar och demoner – Del 3</h3><audio controls><source src="Anglar och demoner Del 3.m4a" type="audio/mp4"></audio></li>
      </ul>
    </div>

  </main>

  <!-- Mini-player bar -->
  <div class="mini-player" id="miniPlayer" aria-live="polite">
    <div class="mini-row">
      <div class="mini-left">
        <div class="mini-title" id="miniTitle">Ingen uppspelning</div>
        <div class="mini-sub" id="miniSub">—</div>
      </div>

      <div class="mini-controls">
        <button class="mini-btn" id="miniPlayPause" type="button">Play</button>
        <input class="mini-range" id="miniSeek" type="range" min="0" max="1000" value="0" step="1" />
        <div class="mini-time" id="miniTime">0:00 / 0:00</div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button class="mini-btn secondary" id="miniShow" type="button">Visa</button>
        <button class="mini-btn secondary" id="miniClear" type="button">Rensa</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Kontakt: <a href="mailto:martin.harsmar@live.se">martin.harsmar@live.se</a></p>
    <p>Karlskoga-Degerfors Baptistförsamling</p>
    <p>Telefon: 073-613 0782</p>
  </footer>

  <script>
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    const hoverSound = new Audio('hover.wav');
    const clickSound = new Audio('click.wav');

    function activateTab(tabId) {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));

      const tabEl = Array.from(tabs).find(t => t.dataset.tab === tabId);
      const contentEl = document.getElementById(tabId);

      if (tabEl) tabEl.classList.add('active');
      if (contentEl) contentEl.classList.add('active');
    }

    tabs.forEach(tab => {
      tab.addEventListener('mouseenter', () => {
        hoverSound.currentTime = 0;
        hoverSound.play();
      });

      tab.addEventListener('click', () => {
        activateTab(tab.dataset.tab);
        clickSound.currentTime = 0;
        clickSound.play();
      });
    });

    // --- Audio UX: "Spelas nu" + autopause + autoscroll + längd + minne + mini-player ---
    const STORAGE_KEY = 'pmh_last_play';
    const audios = Array.from(document.querySelectorAll('audio'));

    const miniPlayer = document.getElementById('miniPlayer');
    const miniTitle = document.getElementById('miniTitle');
    const miniSub = document.getElementById('miniSub');
    const miniPlayPause = document.getElementById('miniPlayPause');
    const miniSeek = document.getElementById('miniSeek');
    const miniTime = document.getElementById('miniTime');
    const miniShow = document.getElementById('miniShow');
    const miniClear = document.getElementById('miniClear');

    let currentAudio = null;
    let currentTabId = null;
    let currentTitleText = null;
    let seeking = false;

    function formatTime(totalSeconds) {
      if (!Number.isFinite(totalSeconds) || totalSeconds < 0) return '0:00';
      const sec = Math.floor(totalSeconds);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      const ss = String(s).padStart(2, '0');
      if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${ss}`;
      return `${m}:${ss}`;
    }

    function clearNowPlaying() {
      document.querySelectorAll('li.playing').forEach(li => li.classList.remove('playing'));
      document.querySelectorAll('.now-playing').forEach(badge => badge.remove());
    }

    function ensureBadgesContainer(h3) {
      let wrap = h3.querySelector('.badges');
      if (!wrap) {
        wrap = document.createElement('span');
        wrap.className = 'badges';
        h3.appendChild(wrap);
      }
      return wrap;
    }

    function setNowPlaying(audio) {
      const li = audio.closest('li');
      if (!li) return;

      clearNowPlaying();
      li.classList.add('playing');

      const h3 = li.querySelector('h3');
      if (h3) {
        const wrap = ensureBadgesContainer(h3);
        const badge = document.createElement('span');
        badge.className = 'now-playing';
        badge.textContent = 'Spelas nu';
        wrap.appendChild(badge);
      }

      setTimeout(() => {
        li.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 50);
    }

    function setDurationBadgeFor(audio) {
      const li = audio.closest('li');
      if (!li) return;
      const h3 = li.querySelector('h3');
      if (!h3) return;

      if (h3.querySelector('.time-badge')) return;
      if (!Number.isFinite(audio.duration) || audio.duration <= 0) return;

      const wrap = ensureBadgesContainer(h3);
      const time = document.createElement('span');
      time.className = 'time-badge';
      time.textContent = formatTime(audio.duration);
      wrap.appendChild(time);
    }

    function getAudioSrc(audio) {
      const source = audio.querySelector('source');
      return source ? source.getAttribute('src') : null;
    }

    function getTitleFor(audio) {
      const li = audio.closest('li');
      const h3 = li ? li.querySelector('h3') : null;
      return h3 ? h3.childNodes[0].textContent.trim() : 'Okänt avsnitt';
    }

    function getTabIdFor(audio) {
      const content = audio.closest('.tab-content');
      return content ? content.id : null;
    }

    function showMiniPlayer() {
      miniPlayer.classList.add('active');
      document.body.classList.add('has-mini-player');
    }

    function hideMiniPlayer() {
      miniPlayer.classList.remove('active');
      document.body.classList.remove('has-mini-player');
    }

    function updateMiniUI() {
      if (!currentAudio) return;

      const dur = Number.isFinite(currentAudio.duration) ? currentAudio.duration : 0;
      const cur = Number.isFinite(currentAudio.currentTime) ? currentAudio.currentTime : 0;

      if (!seeking) {
        const max = 1000;
        const val = dur > 0 ? Math.round((cur / dur) * max) : 0;
        miniSeek.value = String(val);
      }

      miniTime.textContent = `${formatTime(cur)} / ${formatTime(dur)}`;
      miniPlayPause.textContent = currentAudio.paused ? 'Play' : 'Paus';
    }

    function setCurrent(audio, options = { scroll: true }) {
      currentAudio = audio;
      currentTabId = getTabIdFor(audio);
      currentTitleText = getTitleFor(audio);

      miniTitle.textContent = currentTitleText;
      miniSub.textContent = currentTabId ? `Kategori: ${tabLabelFromId(currentTabId)}` : '—';

      showMiniPlayer();
      setNowPlaying(audio);

      if (options.scroll) {
        const li = audio.closest('li');
        if (li) setTimeout(() => li.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
      }

      updateMiniUI();
      saveState(); // spara direkt när man byter avsnitt
    }

    function tabLabelFromId(tabId) {
      const tabEl = Array.from(tabs).find(t => t.dataset.tab === tabId);
      return tabEl ? tabEl.textContent.trim() : tabId;
    }

    // Spara senast spelade (throttlat)
    let lastSaveTs = 0;
    function saveState(force = false) {
      if (!currentAudio) return;
      const now = Date.now();
      if (!force && now - lastSaveTs < 1200) return; // ca 1 gång/sek max
      lastSaveTs = now;

      const src = getAudioSrc(currentAudio);
      if (!src) return;

      const state = {
        src,
        title: currentTitleText || getTitleFor(currentAudio),
        tabId: currentTabId || getTabIdFor(currentAudio),
        time: currentAudio.currentTime || 0,
        dur: Number.isFinite(currentAudio.duration) ? currentAudio.duration : null
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
    }

    function findAudioBySrc(src) {
      return audios.find(a => getAudioSrc(a) === src) || null;
    }

    function restoreState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;

      let state = null;
      try { state = JSON.parse(raw); } catch (e) { return; }
      if (!state || !state.src) return;

      const a = findAudioBySrc(state.src);
      if (!a) return;

      // Aktivera rätt tab (så "Visa" och markering blir korrekt)
      if (state.tabId) activateTab(state.tabId);

      // Sätt currentAudio och UI (utan autoplay)
      setCurrent(a, { scroll: false });

      // När metadata finns kan vi sätta tid
      const targetTime = Number.isFinite(state.time) ? state.time : 0;
      const applyTime = () => {
        try { a.currentTime = targetTime; } catch (e) {}
        updateMiniUI();
      };

      if (a.readyState >= 1) {
        applyTime();
      } else {
        a.addEventListener('loadedmetadata', applyTime, { once: true });
      }

      miniSub.textContent = (state.tabId ? `Återställ: redo i ${tabLabelFromId(state.tabId)}` : 'Återställ: redo');
    }

    // Längd-badges
    audios.forEach(a => {
      a.addEventListener('loadedmetadata', () => setDurationBadgeFor(a));
      if (a.readyState >= 1) setDurationBadgeFor(a);
    });

    // Autopausa + now playing + mini-player + minne
    audios.forEach(a => {
      a.addEventListener('play', () => {
        audios.forEach(other => {
          if (other !== a && !other.paused) other.pause();
        });
        setCurrent(a, { scroll: true });
        saveState(true);
      });

      a.addEventListener('timeupdate', () => {
        if (currentAudio === a) {
          updateMiniUI();
          saveState(false);
        }
      });

      a.addEventListener('pause', () => {
        if (currentAudio === a) {
          updateMiniUI();
          saveState(true);
        }
      });

      a.addEventListener('ended', () => {
        if (currentAudio === a) {
          updateMiniUI();
          saveState(true);
          clearNowPlaying();
          // Vi låter mini-player vara kvar, så man kan trycka play igen om man vill
          miniPlayPause.textContent = 'Play';
        }
      });
    });

    // Mini-player kontroller
    miniPlayPause.addEventListener('click', () => {
      if (!currentAudio) return;
      if (currentAudio.paused) {
        currentAudio.play();
      } else {
        currentAudio.pause();
      }
    });

    miniSeek.addEventListener('input', () => {
      seeking = true;
      if (!currentAudio) return;
      const dur = Number.isFinite(currentAudio.duration) ? currentAudio.duration : 0;
      if (dur <= 0) return;
      const val = Number(miniSeek.value);
      const max = 1000;
      const t = (val / max) * dur;
      miniTime.textContent = `${formatTime(t)} / ${formatTime(dur)}`;
    });

    miniSeek.addEventListener('change', () => {
      seeking = false;
      if (!currentAudio) return;
      const dur = Number.isFinite(currentAudio.duration) ? currentAudio.duration : 0;
      if (dur <= 0) return;
      const val = Number(miniSeek.value);
      const max = 1000;
      const t = (val / max) * dur;
      try { currentAudio.currentTime = t; } catch (e) {}
      updateMiniUI();
      saveState(true);
    });

    miniShow.addEventListener('click', () => {
      if (!currentAudio) return;
      const tabId = currentTabId || getTabIdFor(currentAudio);
      if (tabId) activateTab(tabId);

      const li = currentAudio.closest('li');
      if (li) setTimeout(() => li.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
      setNowPlaying(currentAudio);
    });

    miniClear.addEventListener('click', () => {
      // Stoppa uppspelning och glöm allt
      if (currentAudio && !currentAudio.paused) currentAudio.pause();
      clearNowPlaying();
      currentAudio = null;
      currentTabId = null;
      currentTitleText = null;

      miniTitle.textContent = 'Ingen uppspelning';
      miniSub.textContent = '—';
      miniTime.textContent = '0:00 / 0:00';
      miniSeek.value = '0';
      miniPlayPause.textContent = 'Play';

      clearState();
      hideMiniPlayer();
    });

    // Start: återställ senast lyssnade om det finns
    restoreState();
  </script>
</body>
</html>
